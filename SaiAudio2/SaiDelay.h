#ifndef _SAI_DELAY_H_
#define _SAI_DELAY_H_

#include "libTool.h"
#include "LoadSoundClass.h"
#include "SaiAudio2.h"
#include <xapobase.h>
#pragma comment(lib,"xapobase.lib")

//*****************************************************************************
// マクロ定義
//*****************************************************************************
#define DELAY_TIME_DEFAULT		(1.0f)
#define DELAY_VOLUME_DEFAULT	(0.5f)

//*****************************************************************************
// 構造体宣言
//*****************************************************************************
typedef struct	// SAI式I 遅延処理(only for 2ch)
{
	WAV_FILE		wavFile;		// wavファイル
	float			delayTime;		// 遅延の秒数
	float			volume;			// 残響の音量

}SAI_APO_DELAY;

//*****************************************************************************
// SAI_DELAY_APO (only for 2ch)
//*****************************************************************************
class __declspec(uuid("{80D4BED4-7605-4E4C-B29C-5479C375C599}"))SAI_DELAY_APO : public CXAPOParametersBase
{
public:
	SAI_DELAY_APO(SAI_VOICE_TOOL *svt);	// 初期化用
	~SAI_DELAY_APO();					// 終了用

	// LockForProcessのオーバーライド
	STDMETHOD(LockForProcess)
		(UINT32 inputLockedParameterCount,
			const XAPO_LOCKFORPROCESS_BUFFER_PARAMETERS * pInputLockedParameters,
			UINT32 outputLockedParameterCount,
			const XAPO_LOCKFORPROCESS_BUFFER_PARAMETERS * pOutputLockedParameters)
		override;

	// Processのオーバーライド
	STDMETHOD_(void, Process)
		(UINT32 inputProcessParameterCount,
			const XAPO_PROCESS_BUFFER_PARAMETERS * pInputProcessParameters,
			UINT32 outputProcessParameterCount,
			XAPO_PROCESS_BUFFER_PARAMETERS * pOutputProcessParameters,
			BOOL isEnabled)
		override;

	// OnSetParametersのオーバーライト
	virtual void OnSetParameters
	(const void* pParameters, UINT32 ParameterByteSize);

private:
	static XAPO_REGISTRATION_PROPERTIES _regProps;

	// フォーマット
	WAVEFORMATEX inFormat;
	WAVEFORMATEX outFormat;

	// エコー用
	float	*backupBuf;
	int		delaySample;
	int		readPos;
	int		writePos;
	bool	play;

	// WAVファイル
	WAV_FILE	wavFmt;

	// パラメータ
	SAI_APO_DELAY apoParameter[3];
};

#endif